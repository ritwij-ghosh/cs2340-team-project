{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-12">
      <div class="card bg-dark border-secondary">
        <div class="card-header text-light d-flex justify-content-between align-items-center">
          <h3 class="mb-0">
            <i class="fas fa-map-marked-alt me-2"></i>Job Map
          </h3>
          <div class="d-flex align-items-center gap-3">
            <span class="badge bg-primary">{{ jobs_count }} jobs on map</span>
            <a href="{% url 'jobs:index' %}" class="btn btn-outline-light btn-sm">
              <i class="fas fa-list me-1"></i>List View
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="map" style="height: 600px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the map centered on the US
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Job data from Django
    const jobsData = {{ jobs_data|safe }};
    
    // Create markers for each job
    const markers = [];
    
    jobsData.forEach(function(job) {
        // Create custom icon based on work type
        let iconColor = 'blue';
        if (job.work_type === 'Remote') {
            iconColor = 'green';
        } else if (job.work_type === 'Hybrid') {
            iconColor = 'orange';
        }
        
        const customIcon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        // Create popup content
        const popupContent = `
            <div class="job-popup">
                <h6 class="fw-bold mb-2" style="color: black;">${job.title}</h6>
                <p class="mb-1" style="color: black;"><strong>${job.company}</strong></p>
                <p class="mb-1" style="color: black;">${job.location}</p>
                <div class="mb-2">
                    <span class="badge bg-primary me-1">${job.employment_type}</span>
                    <span class="badge bg-secondary me-1">${job.work_type}</span>
                </div>
                ${job.salary_display !== 'Salary not specified' ? `<p class="mb-2 text-success"><strong>${job.salary_display}</strong></p>` : ''}
                ${job.skills.length > 0 ? `<p class="mb-2" style="color: black;"><small>Skills: ${job.skills.join(', ')}</small></p>` : ''}
                <a href="${job.url}" class="btn btn-primary btn-sm">View Details</a>
            </div>
        `;
        
        // Create marker
        const marker = L.marker([job.latitude, job.longitude], { icon: customIcon })
            .addTo(map)
            .bindPopup(popupContent);
        
        markers.push(marker);
    });
    
    // Fit map to show all markers
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Add legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend bg-light p-2 rounded');
        div.innerHTML = `
            <h6 class="mb-2" style="color: black;">Work Type</h6>
            <div class="d-flex align-items-center mb-1">
                <div style="background-color: blue; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px;"></div>
                <small style="color: black;">On-site</small>
            </div>
            <div class="d-flex align-items-center mb-1">
                <div style="background-color: orange; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px;"></div>
                <small style="color: black;">Hybrid</small>
            </div>
            <div class="d-flex align-items-center">
                <div style="background-color: green; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px;"></div>
                <small style="color: black;">Remote</small>
            </div>
        `;
        return div;
    };
    legend.addTo(map);
    
    // Add search functionality
    const searchControl = L.control({position: 'topleft'});
    searchControl.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'search-control bg-light p-2 rounded');
        div.innerHTML = `
            <input type="text" id="location-search" placeholder="Search location..." class="form-control form-control-sm mb-2">
            <button id="search-btn" class="btn btn-primary btn-sm w-100">Search</button>
        `;
        
        // Add search functionality
        const searchInput = div.querySelector('#location-search');
        const searchBtn = div.querySelector('#search-btn');
        
        searchBtn.addEventListener('click', function() {
            const query = searchInput.value.trim();
            if (query) {
                // Use Nominatim API for geocoding
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const result = data[0];
                            map.setView([parseFloat(result.lat), parseFloat(result.lon)], 10);
                        } else {
                            alert('Location not found');
                        }
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        alert('Search failed');
                    });
            }
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });
        
        return div;
    };
    searchControl.addTo(map);
});
</script>

<style>
.custom-div-icon {
    background: none !important;
    border: none !important;
}

.job-popup {
    min-width: 250px;
}

.job-popup h6 {
    color: black !important;
    margin-bottom: 8px;
}

.job-popup p {
    color: black !important;
}

.job-popup small {
    color: black !important;
}

.job-popup .badge {
    font-size: 0.7em;
}

.info {
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.search-control {
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    min-width: 200px;
}

.search-control input {
    border: 1px solid #ddd;
}

.search-control button {
    font-size: 0.8em;
}
</style>
{% endblock %}
