{% extends 'base.html' %}
{% load static %}
{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h3 class="mb-0">
            <i class="fas fa-plus-circle me-2"></i>Post a New Job
          </h3>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <!-- Basic Information -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="border-bottom pb-2 mb-3">Basic Information</h5>
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.title.id_for_label }}" class="form-label">Job Title *</label>
                {{ form.title }}
                {% if form.title.errors %}
                  <div class="text-danger small">{{ form.title.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.company.id_for_label }}" class="form-label">Company *</label>
                {{ form.company }}
                {% if form.company.errors %}
                  <div class="text-danger small">{{ form.company.errors }}</div>
                {% endif %}
              </div>
              <div class="col-12 mb-3">
                <label for="{{ form.location.id_for_label }}" class="form-label">Location *</label>
                {{ form.location }}
                <small class="form-text text-muted">Enter the job location and click "Find on Map" or click directly on the map to pin the exact office location.</small>
                {% if form.location.errors %}
                  <div class="text-danger small">{{ form.location.errors }}</div>
                {% endif %}
              </div>
              <div class="col-12 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label mb-0">Pin Office Location on Map</label>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="geocodeBtn">
                    <i class="fas fa-search-location me-1"></i>Find on Map
                  </button>
                </div>
                <div id="jobMap" style="height: 400px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
                <small class="form-text text-muted mt-2 d-block">
                  <i class="fas fa-info-circle me-1"></i>
                  Click on the map to pin your office location, or use "Find on Map" to auto-locate based on the address above.
                </small>
                {{ form.latitude }}
                {{ form.longitude }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.employment_type.id_for_label }}" class="form-label">Employment Type</label>
                {{ form.employment_type }}
                {% if form.employment_type.errors %}
                  <div class="text-danger small">{{ form.employment_type.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.experience_level.id_for_label }}" class="form-label">Experience Level</label>
                {{ form.experience_level }}
                {% if form.experience_level.errors %}
                  <div class="text-danger small">{{ form.experience_level.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.work_type.id_for_label }}" class="form-label">Work Type</label>
                {{ form.work_type }}
                {% if form.work_type.errors %}
                  <div class="text-danger small">{{ form.work_type.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-check">
                  {{ form.visa_sponsorship }}
                  <label class="form-check-label" for="{{ form.visa_sponsorship.id_for_label }}">
                    Offers Visa Sponsorship
                  </label>
                </div>
                {% if form.visa_sponsorship.errors %}
                  <div class="text-danger small">{{ form.visa_sponsorship.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                {{ form.status }}
                {% if form.status.errors %}
                  <div class="text-danger small">{{ form.status.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Job Details -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="border-bottom pb-2 mb-3">Job Details</h5>
              </div>
              <div class="col-12 mb-3">
                <label for="{{ form.skills_required.id_for_label }}" class="form-label">Required Skills</label>
                {{ form.skills_required }}
                <small class="form-text text-muted">List key skills separated by commas (e.g., Python, Django, React, PostgreSQL)</small>
                {% if form.skills_required.errors %}
                  <div class="text-danger small">{{ form.skills_required.errors }}</div>
                {% endif %}
              </div>
              <div class="col-12 mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">Job Description *</label>
                {{ form.description }}
                <small class="form-text text-muted">Describe the role, responsibilities, and what the candidate will be doing.</small>
                {% if form.description.errors %}
                  <div class="text-danger small">{{ form.description.errors }}</div>
                {% endif %}
              </div>
              <div class="col-12 mb-3">
                <label for="{{ form.requirements.id_for_label }}" class="form-label">Requirements *</label>
                {{ form.requirements }}
                <small class="form-text text-muted">List required skills, experience, education, and qualifications.</small>
                {% if form.requirements.errors %}
                  <div class="text-danger small">{{ form.requirements.errors }}</div>
                {% endif %}
              </div>
              <div class="col-12 mb-3">
                <label for="{{ form.benefits.id_for_label }}" class="form-label">Benefits (Optional)</label>
                {{ form.benefits }}
                <small class="form-text text-muted">Health insurance, 401k, flexible schedule, remote work options, etc.</small>
                {% if form.benefits.errors %}
                  <div class="text-danger small">{{ form.benefits.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Compensation & Application -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="border-bottom pb-2 mb-3">Compensation & Application</h5>
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.salary_min.id_for_label }}" class="form-label">Minimum Salary (Optional)</label>
                {{ form.salary_min }}
                {% if form.salary_min.errors %}
                  <div class="text-danger small">{{ form.salary_min.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.salary_max.id_for_label }}" class="form-label">Maximum Salary (Optional)</label>
                {{ form.salary_max }}
                {% if form.salary_max.errors %}
                  <div class="text-danger small">{{ form.salary_max.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.application_deadline.id_for_label }}" class="form-label">Application Deadline (Optional)</label>
                {{ form.application_deadline }}
                {% if form.application_deadline.errors %}
                  <div class="text-danger small">{{ form.application_deadline.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.external_url.id_for_label }}" class="form-label">External Application URL (Optional)</label>
                {{ form.external_url }}
                <small class="form-text text-muted">Link to your company's application page.</small>
                {% if form.external_url.errors %}
                  <div class="text-danger small">{{ form.external_url.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Form Errors -->
            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <!-- Submit Buttons -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Post Job
              </button>
              <a href="{% url 'jobs:index' %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i>Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize map centered on US
  const map = L.map('jobMap').setView([39.8283, -98.5795], 4);

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19
  }).addTo(map);

  let marker = null;

  // Function to update marker position
  function updateMarker(lat, lng) {
    if (marker) {
      marker.setLatLng([lat, lng]);
    } else {
      marker = L.marker([lat, lng], {
        draggable: true
      }).addTo(map);

      // Update coordinates when marker is dragged
      marker.on('dragend', function(e) {
        const position = marker.getLatLng();
        document.getElementById('id_latitude').value = position.lat.toFixed(6);
        document.getElementById('id_longitude').value = position.lng.toFixed(6);
      });
    }

    map.setView([lat, lng], 13);
    document.getElementById('id_latitude').value = lat.toFixed(6);
    document.getElementById('id_longitude').value = lng.toFixed(6);
  }

  // Load existing coordinates if available
  const existingLat = document.getElementById('id_latitude').value;
  const existingLng = document.getElementById('id_longitude').value;

  if (existingLat && existingLng) {
    updateMarker(parseFloat(existingLat), parseFloat(existingLng));
  }

  // Click on map to add/move marker
  map.on('click', function(e) {
    updateMarker(e.latlng.lat, e.latlng.lng);
  });

  // Geocode button functionality
  document.getElementById('geocodeBtn').addEventListener('click', async function() {
    const locationInput = document.getElementById('id_location').value;

    if (!locationInput || locationInput.toLowerCase() === 'remote' || locationInput.toLowerCase() === 'anywhere') {
      alert('Please enter a specific location address (not "Remote" or "Anywhere")');
      return;
    }

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Searching...';

    try {
      // Use Nominatim API for geocoding
      const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationInput)}&format=json&limit=1`, {
        headers: {
          'User-Agent': 'HireBuzz/1.0 (Job Board Application)'
        }
      });

      const data = await response.json();

      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lng = parseFloat(data[0].lon);
        updateMarker(lat, lng);
      } else {
        alert('Location not found. Please try a different address or click directly on the map.');
      }
    } catch (error) {
      console.error('Geocoding error:', error);
      alert('Error finding location. Please try clicking directly on the map.');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-search-location me-1"></i>Find on Map';
    }
  });
});
</script>
{% endblock content %}